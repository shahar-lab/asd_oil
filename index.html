<!DOCTYPE html>
<html>

<head>
    <title>Cards</title>

    <!-- online run
    <script src="lib/vendors/jspsych-7.1.2/jspsych.js"></script>
    <script src="lib/vendors/jspsych-7.1.2/plugin-html-keyboard-response.js"></script>
    <script src="lib/vendors/jspsych-7.1.2/plugin-html-button-response.js"></script>
    <script src="lib/vendors/jspsych-7.1.2/plugin-preload.js"></script>
    <script src="lib/vendors/jspsych-7.1.2/plugin-fullscreen.js"></script>
    <script src="lib/vendors/jspsych-7.1.2/plugin-instructions.js"></script>
    <script src="lib/vendors/jspsych-7.1.2/plugin-survey-likert.js"></script>
    <script src="lib/vendors/jspsych-7.1.2/plugin-survey-text.js"></script>
    <script src="lib/vendors/jspsych-7.1.2/plugin-survey-multi-choice.js"></script>
    <link rel="stylesheet" href="lib/vendors/jspsych-7.1.2/jspsych.css">
    <link href="./css/my_exp.css" rel="stylesheet" type="text/css">
    <script type="text/javascript" src="lib/jspsych-7-pavlovia-2022.1.1.js"></script>-->

    <!-- local run-->
    <script src="jspsych/dist/jspsych.js"></script>
    <script src="jspsych/dist/plugin-html-keyboard-response.js"></script>
    <script src="jspsych/dist/plugin-html-button-response.js"></script>
    <script src="jspsych/dist/plugin-preload.js"></script>
    <script src="jspsych/dist/plugin-instructions.js"></script>
    <script src="jspsych/dist/plugin-survey-likert.js"></script>
    <script src="jspsych/dist/plugin-survey-text.js"></script>
    <script src="jspsych/dist/plugin-survey-multi-choice.js"></script>
    <script src="jspsych/dist/plugin-fullscreen.js"></script>
    <script src="jspsych/dist/plugin-html-slider-response.js"></script>
    <link href="jspsych/dist/jspsych.css" rel="stylesheet" type="text/css" />
    <link href="css/my_exp.css" rel="stylesheet" type="text/css"/>

</head>

<body>

    <script>

        var jsPsych = initJsPsych({
            on_finish: function () {
                download_csv(jsPsych.data.get().csv());
            }
         });
        /*this defines the css properties according to the window_screen_size*/
        var root = document.documentElement;
        var vis_angle_px = 105
        var square_width = 51.4
        root.style.setProperty('--top_middle', window.screen.height / 2 + "px");
        root.style.setProperty('--left_middle', window.screen.width / 2 - (square_width / 2) + "px");
        root.style.setProperty('--top_a', window.screen.height / 2 - vis_angle_px + "px");
        root.style.setProperty('--left_a', window.screen.width / 2 - vis_angle_px + "px");
        root.style.setProperty('--top_b', window.screen.height / 2 - 2 * vis_angle_px + "px");
        root.style.setProperty('--left_b', window.screen.width / 2 - 2 * vis_angle_px + "px");
        root.style.setProperty('--top_c', window.screen.height / 2 - 3 * vis_angle_px + "px");
        root.style.setProperty('--left_c', window.screen.width / 2 - 3 * vis_angle_px + "px");
        root.style.setProperty('--top_d', window.screen.height / 2 - vis_angle_px + "px");
        root.style.setProperty('--right_d', window.screen.width / 2 - vis_angle_px + "px");
        root.style.setProperty('--top_e', window.screen.height / 2 - 2 * vis_angle_px + "px");
        root.style.setProperty('--right_e', window.screen.width / 2 - 2 * vis_angle_px + "px");
        root.style.setProperty('--top_f', window.screen.height / 2 - 3 * vis_angle_px + "px");
        root.style.setProperty('--right_f', window.screen.width / 2 - 3 * vis_angle_px + "px");
        root.style.setProperty('--bottom_g', window.screen.height / 2 - vis_angle_px + "px");
        root.style.setProperty('--right_g', window.screen.width / 2 - vis_angle_px + "px");
        root.style.setProperty('--bottom_h', window.screen.height / 2 - 2 * vis_angle_px + "px");
        root.style.setProperty('--right_h', window.screen.width / 2 - 2 * vis_angle_px + "px");
        root.style.setProperty('--bottom_i', window.screen.height / 2 - 3 * vis_angle_px + "px");
        root.style.setProperty('--right_i', window.screen.width / 2 - 3 * vis_angle_px + "px");
        root.style.setProperty('--bottom_j', window.screen.height / 2 - vis_angle_px + "px");
        root.style.setProperty('--left_j', window.screen.width / 2 - vis_angle_px + "px");
        root.style.setProperty('--bottom_k', window.screen.height / 2 - 2 * vis_angle_px + "px");
        root.style.setProperty('--left_k', window.screen.width / 2 - 2 * vis_angle_px + "px");
        root.style.setProperty('--bottom_l', window.screen.height / 2 - 3 * vis_angle_px + "px");
        root.style.setProperty('--left_l', window.screen.width / 2 - 3 * vis_angle_px + "px");

        root.style.setProperty('--upper1', window.screen.height / 2 - 3 * vis_angle_px + "px");
        root.style.setProperty('--upper2', window.screen.height / 2 - 2 * vis_angle_px + "px");
        root.style.setProperty('--upper3', window.screen.height / 2 - vis_angle_px + "px");

        root.style.setProperty('--lower1', window.screen.height / 2 - 3 * vis_angle_px + "px");
        root.style.setProperty('--lower2', window.screen.height / 2 - 2 * vis_angle_px + "px");
        root.style.setProperty('--lower3', window.screen.height / 2 - vis_angle_px + "px");
        //---------------------------------------------------------------------------------------------
        root.style.setProperty('--left_card', window.screen.width / 2 - 2 * vis_angle_px + "px");
        root.style.setProperty('--right_card', window.screen.width / 2 - 2 * vis_angle_px + "px");
        root.style.setProperty('--top_card', window.screen.height / 2 - 90 + "px");
        root.style.setProperty('--top_reward', window.screen.height / 2 + "px");
        root.style.setProperty('--left_reward', window.screen.width / 2 + "px");

        /*---------------------------------------------------- 
        Variabels for card game
        ------------------------------------------------------*/
        var instructions_images = ['images/group_shapes.jpg', 'images/reward_example.jpg','images/no_reward_example.jpg']
        var practice_deck_images = ['images/practice/1.jpg','images/practice/2.jpg','images/practice/3.jpg','images/practice/4.jpg','images/practice/5.jpg','images/practice/6.jpg','images/practice/7.jpg','images/practice/8.jpg','images/practice/9.jpg','images/practice/10.jpg' ]
        var test_deck_images = ['images/test/1.jpg', 'images/test/2.jpg', 'images/test/3.jpg', 'images/test/4.jpg', 'images/test/5.jpg','images/test/6.jpg',
        'images/test/7.jpg', 'images/test/8.jpg', 'images/test/9.jpg', 'images/test/10.jpg', 'images/test/11.jpg', 'images/test/12.jpg', 'images/test/13.jpg',
        'images/test/14.jpg', 'images/test/15.jpg', 'images/test/16.jpg','images/test/17.jpg', 'images/test/18.jpg', 'images/test/19.jpg', 'images/test/20.jpg', 'images/test/21.jpg',
        'images/test/22.jpg', 'images/test/23.jpg', 'images/test/24.jpg', 'images/test/25.jpg', 'images/test/26.jpg', 'images/test/27.jpg', 'images/test/28.jpg',
        'images/test/29.jpg', 'images/test/30.jpg', 'images/test/31.jpg', 'images/test/32.jpg', 'images/test/33.jpg', 'images/test/34.jpg', 'images/test/35.jpg', 'images/test/36.jpg',
        'images/test/37.jpg', 'images/test/38.jpg', 'images/test/39.jpg', 'images/test/40.jpg']
        var reward_images = ['images/zero_coins.png', 'images/won1-no-back1.png']
        var fixation = '<div class="fixation">+</div>'

        var FB_matrix = [0.4, 0.6, 0.4, 0.6];
        var current_cards_practice_trial = 0;
        var current_cards_exp_trial = 0;
        var block = 0;
        var blocks = 10;
        var draw_cards;
        var drawn_cards;
        var left_card;
        var right_card;
        var selected;
        var reward;
        var rewards_for_block = 0;
        
        /*---------------------------------------------------- 
        Variabels for squares game
        ------------------------------------------------------*/
        /*randomly assigning the mapping of the response-keys to be ks or sk */ //cr: what does it mean? ks? sk?
        mapping = jsPsych.randomization.sampleWithoutReplacement(['sk', 'ks'], 1)[0];
        /* getting the images to display */
        var change_detection_images = ['images/squares/black.png', 'images/squares/blue.png', 'images/squares/brown.png', 'images/squares/cyan.png', 'images/squares/green.png', 'images/squares/magenta.png', 'images/squares/orange.png', 'images/squares/red.png', 'images/squares/yellow.png']
        /* setting the locations to randomize from */
        var locations = ["<img class='a' src=", "<img class='b' src=", "<img class='c' src=", "<img class='d' src=", "<img class='e' src=", "<img class='f' src=", "<img class='g' src=", "<img class='h' src=", "<img class='i' src=", "<img class='j' src=", "<img class='k' src=", "<img class='l' src=",]
        var locations_setsize1 = ["<img class='upper1' src=", "<img class='upper2' src=", "<img class='upper3' src=", "<img class='lower1' src=", "<img class='lower2' src=", "<img class='lower3' src="]
       
        var preload = {
            type: jsPsychPreload,
            images: [practice_deck_images, test_deck_images, reward_images, instructions_images,change_detection_images]
        };
        /*---------------------------------------------------- 
        Functions for card game
        ------------------------------------------------------*/

        function draw_show_cards(current_trial,deck) {
            if (current_trial%2==0){
            drawn_cards=jsPsych.randomization.shuffle([deck[0],deck[1]]) 
            }
            else{
            drawn_cards=jsPsych.randomization.shuffle([deck[2],deck[3]])
            }
            left_card = drawn_cards[0];
            right_card = drawn_cards[1];
            left_with_tag = "<img class='card_left' src='" + left_card + "'>"
            right_with_tag = "<img class='card_right' src='" + right_card + "'>"
            return left_with_tag + right_with_tag + fixation;
        }
        
        function show_choice() {

            last_choice = jsPsych.data.getLastTrialData().values()[0].response
            if (last_choice == 's') {
                selected = 0
                card_to_show = "<img class='card_left' src='" + left_card + "'>"
            }
            else if (last_choice == 'k') {
                selected = 1
                card_to_show = "<img class='card_right' src='" + right_card + "'>"
            }
            else if (last_choice == null) {
                selected = null
                reward = 0
                return '<div style="font-size:40px;">Please respond faster!</div>'
            }
            else {
                selected = -1
                reward = 0
                return '<div style="font-size:40px;">wrong key!</div><br><br><div style="font-size:20px;">Please use the ‘K’ and ‘S’ keys to select the left or right card respectively. </div>'
            }
            return card_to_show + fixation
        }

        function show_reward(current_trial_num) {
            key_selected = jsPsych.data.getLastTrialData().values()[0].key_selected
            if (key_selected == 0) {
                card_to_show = "<img class='card_left' src='" + left_card + "'>"
            }
            else if (key_selected == 1) {
                card_to_show = "<img class='card_right' src='" + right_card + "'>"
            }
            else if (key_selected == null) {
                return '<div style="font-size:40px;">Please respond faster!</div>'
            }
            else {
                return '<div style="font-size:40px;">wrong key!</div><br><br><div style="font-size:20px;">Please use the ‘K’ and ‘S’ keys to select the left or right card respectively. </div>'
            }
            card_selected = jsPsych.data.getLastTrialData().values()[0].card_selected 
            prob_reward = FB_matrix[card_selected]; 
            prob_unreward = 1 - prob_reward; 
            reward = jsPsych.randomization.sampleWithReplacement([0, 1], 1, [prob_unreward, prob_reward])[0]; 
            reward_to_show = "<img class=reward src='" + reward_images[reward] + "'>" 


            return card_to_show + reward_to_show
        }
        
        function images_for_block_start() {
            images = test_deck_images.slice(block * 4, block * 4 + 4)
            return images
        }
        /*---------------------------------------------------- 
        Functions for squares game
        ------------------------------------------------------*/
        //This function decides on a random location for the test square
        function getRandomInt(max) {
            return Math.floor(Math.random() * Math.floor(max));
        }
        //This function picks random squares to show
        function get_squares(images, number_of_images) {
            return jsPsych.randomization.sampleWithoutReplacement(change_detection_images, number_of_images)
        }
        /*This function picks the locations in which the squares will be shown 
         It also takes care of equally randomizing the different quadrants   */
        function get_locations(locations_arr, number_of_images, locations_arr1) {
            random_locations = [];
            if (number_of_images == 1) {
                return jsPsych.randomization.sampleWithoutReplacement(locations_arr1, 1)
            }
            for (var i = 0; i < 4; i++) {
                random_2_locations = jsPsych.randomization.sampleWithoutReplacement(locations_arr.slice(i * 3, i * 3 + 3), 2)
                random_locations.push(random_2_locations[0])
                if (number_of_images > 4) {
                    random_locations.push(random_2_locations[1])
                }
            }
            return random_locations
        }
        /*This function combines the squares and the locations that were randomly chosen */
        function generate_random_squares(condition) {
            number_of_images = parseInt(condition[0])
            change_detection_images = jsPsych.randomization.shuffle(change_detection_images)
            current_locations = get_locations(locations, number_of_images, locations_setsize1)
            squares = '';
            for (index = 0; index < number_of_images; index++) {
                squares += current_locations[index] + change_detection_images[index] + ">"
            }
            return squares + fixation;
        }
        var condition_squares_exp = jsPsych.randomization.sampleWithoutReplacement(['4same', '4diff', '8same', '8diff'], 1)[0]
       
        /*---------------------------------------------------- 
        Card game starts
        ------------------------------------------------------*/
        /*full screen */
        var enter_fullscreen = {
            type: jsPsychFullscreen,
            message: '<p>This experiment will be in fullscreen mode. <br> <b>Please make sure your browser is on 100% zoom, and your keyboard is on the English language.</b></p>',
            fullscreen_mode: true
        }
      
        /*---------------------------------------------------- 
        Start instructions
        ------------------------------------------------------*/
        var instructions_cards = {
            on_start: function () {
                if (document.querySelector('#cursor-toggle') != null) {
                    document.querySelector('#cursor-toggle').remove()
                }
            },
            type: jsPsychInstructions,
            pages: ["<p><b><u>Welcome to the game</u></b></p>"
               + "<p style='text-align:left'>Your winnings in this game will earn you additional payment bonus for participating in the study."
               + " If you do not earn any extra money in the card game, you will still receive <b>&pound5 per hour</b> for completing this session of the study."
               + " However, you can gain up to an <b>extra &pound1 based on winnings in the game.</b></p>"
               + "<u>Feel free to go back and forth between the screens using the keyboard left and right arrows or the buttons below.</u><br><br>"
               ,
            "<p style='text-align:left'> We will now provide instructions regarding the game. <b>Please read them carefully.</b> <br></p>"
           ,
            "<p style='text-align:left'>Once you finished reading the instructions, <b>we will ask you to take a quick quiz</b> to make sure you understood everything correctly.</p>",

            "<p style='text-align:left'>On each step of the game, you will be presented with a choice between two shapes."
                +" To select the <b>left shape</b>, press 's' on your keyboard, and to select the <b>right card</b>, press 'k'.</p>"
            + "<img class='example' src= " + instructions_images[0] + ">",

            "<p style='text-align:left'>Once you made your selection, you will  <b>see the <u>selected shape</u> alongside a coin outcome</b> displayed in the center of the screen. <br>The outcome can either be <b>winning a golden coin</b>, as illustrated below, or...</p>"
            +"<br> <img class='reward_example' src= " + instructions_images[1] + ">",
            "<p style='text-align:left'>it could be <b>not winning a coin, as presented here</b></p>"
            + "<br> <img class='reward_example' src= " + instructions_images[2] + ">",
            "<b>Some shapes give golden coins more often</b> than others. <br> Your task is to <b>learn this and choose accordingly.</b> <br><br><u>These golden coins translate to your money bonus</u>. ",
            "Please note that <b>each shape has its own winning chances</b>.<br><br> Learning about one shape tells you nothing about the other shapes. Finding out that one shape gives you coins often, doesn't mean the other one would not.</p>",
            "In this task you will play <b>10 rounds</b> with <b>20 shape choices</b> in each round. On each round you will see a <b>total of 4 different shapes.</b>"
            ,"<p style='text-align:left'><u>Three important things to remember:</u><br>"
                + "1. <b>How good a shape is will not change during the round</b> - it's just that bad shapes can sometimes bring you a golden coin and vice versa."
                + "<br><br>2.<b> Only the shapes matter when you choose - </b> the location of the shape and the response key you used to select it do not influence the chances of winning a coin.<br><br>"
                + " 3. <b>Each shape has its own winning chances - </b> you can't learn about one shape from the rewards you got for the other."
                + " <br><br><u>Please do your best to earn as many coins as you can, while responding quickly as possible.</u><br><br></p>"],
            show_clickable_nav: true
        };
        
        var start_instructions_test = {
            on_start: function () {
                if (document.querySelector('#cursor-toggle') != null)
                    document.querySelector('#cursor-toggle').remove()
            },
            type: jsPsychHtmlKeyboardResponse,
            stimulus: "<p> <br><br> You will now move on to a quick quiz to make sure you understood the instructions. <b>If you will have a mistake you will need to go again through the instructions.</b> <br>Make sure you scroll down until you answer all questions. <br><br> <b> Press any key to continue</b></p>"
        }
        var Q1_2_options = ["2", "4", "6"];
        var Q3_options = ["Click on it", "Press the LEFT or RIGHT arrow keys", "Press the `S` or `K` key with your LEFT or RIGHT hand."];
        var Q4_5_6_7_options = ["True", "False"];
        var Q8_options = ["The goal is to win as many coins as possible", "The goal is to answer the questions as quickly as possible"]
        var Q9_options = ["True","False - what I learn about one shape does not tell me anything about the others. I can only learn whether a shape is good or not by choosing it."];
        var Q10_options = ["True - the response keys are related to the winning chances", "False - you won't win more or less using RIGHT or LEFT response keys. Only the shapes are related to your chances of winning."];

        var instructions_test = {
            type: jsPsychSurveyMultiChoice,
            questions: [
                { prompt: "How many shapes are presented on each choice?", name: 'cards_step', correct: '2', options: Q1_2_options, required: true },
                { prompt: "How many shapes in total are there in each round?", name: 'deck_size', correct: '4', options: Q1_2_options, required: true },
                { prompt: "How do you choose a shape?", name: 'choose_card', correct: 'Press the `S` or `K` key with your LEFT or RIGHT hand.', options: Q3_options, required: true },
                { prompt: "Money bonus depends on the number of golden coins I obtain", name: 'block_stakes', correct: "True", options: Q4_5_6_7_options, required: true },
                { prompt: "Some shapes are better than others.", name: 'better_cards', correct: 'True', options: Q4_5_6_7_options, required: true },
                { prompt: "How `good` or `bad` a shape is will change along the round.", name: 'value_change', correct: 'False', options: Q4_5_6_7_options, required: true },
                { prompt: "What is the goal of the game?", name: 'game_goal', correct: "The goal is to win as many coins as possible", options: Q8_options, required: true },
                { prompt: "If one shape often leads to winning coins, then the other ones are less likely to lead to winning coins.", name: 'value_independence', 
                correct: "False - what I learn about one shape does not tell me anything about the others. I can only learn whether a shape is good or not by choosing it.", options: Q9_options, required: true },
                { prompt: "If you use the RIGHT and not the LEFT response keys, you might win more.", name: 'location_value', 
                correct: "False - you won't win more or less using RIGHT or LEFT response keys. Only the shapes are related to your chances of winning.", options: Q10_options, required: true },
            ],
        };

        var if_trial = {
            type: jsPsychHtmlButtonResponse,
            stimulus: "<p>Sorry. You made a mistake.<br>"
                + "Let`s go back to the instructions. "
                + "Please read them carefully before submitting your answers. <br>"
                + "Thank you!",
            choices: ['Back to instructions']
        }
        var to_repeat;
        var check_answers = {
            timeline: [if_trial],
            conditional_function: function () {
                to_repeat = false;
                var responses_to_test = jsPsych.data.get().filter({ trial_type: 'survey-multi-choice' }).last(1).select('response').values[0]
                for (i = 0; i < instructions_test.questions.length; i++) {
                    current_name = instructions_test.questions[i].name;
                    current_correct = instructions_test.questions[i].correct
                    if (current_correct != responses_to_test[current_name]) {
                        to_repeat = true;
                        return to_repeat
                    }
                    else {
                        to_repeat = false;

                    }
                }
                return to_repeat
            }
        }

        /*---------------------------------------------------- 
        Start instructions variabels
        ------------------------------------------------------*/
        var instructions_squares = {
            type: "instructions",
            pages: ["The experiment will have two parts, we will now learn the first one, called the <b>'squares game'</b>.",
                "We will now provide instructions regarding the squares game. <b>Please read them carefully.</b>",
                "Feel free to <b>go back and forth between the screens using the arrows</b> (Left=previous, Right=next) or the buttons below."
                , "At the end of the instructions, <b>we will ask you to complete a short quiz about them</b>, to make sure everything is well understood."
                , "In this part of the experiment, you will see a plus in the middle of the screen." +
                "<p> We would like you to <b>focus on the plus whenever it appears</b>.</p> " + "<img src='images/fixation.png'>",
                "<p> Then, 4 or 8 colored 'memory' squares will appear on the screen. <b>You need to remember the colors and locations of all of the squares</b>.</p>" +
                "<img src='images/squares/example1.png'>",
                "<p> Right afterward, the 'memory' squares will disappear and instead, one 'test' square will show up in a place where one of the squares was previously displayed.</p>" +
                "<p> Your goal is to <b>identify whether the new 'test' square is in the same or different color as the one previously displayed in this location</b>.</p>" +
                "<p> You need to press <b>'" + mapping[0] + "'</b> if you think the color is the <b>same</b> as the color of the square previously appearing in this location.</p>" +
                "<img src='images/squares/example2.png'>",
                "<p> You need to press <b>'" + mapping[1] + "'</b> if you think the color is <b>different</b> than the color of the square previously appearing in this location.</p>" +
                "<img src='images/squares/example3.png'>", "<p> We will now ask you to complete a short quiz to make sure that you understood the instructions."],
            show_clickable_nav: true,
        };

        var Q1_square_options = ["2 or 4", "4 or 6", "4 or 8"];
        var Q2_square_options = ["True", "False"];
        var Q3_square_options = ["Click on it", "Press the LEFT or RIGHT arrow keys", "Press the ‘" + mapping[0] + "’ or ‘" + mapping[1] + "’ key."];
        var Q4_square_options = ["The plus appearing in the middle of the screen", "The colors and locations of the 'memory' squares", "The color and location of the single 'test' square"];
        var Q5_square_options = ["To tell if the 'test' square is in the same color as the square previously appearing in this location", "To tell if a square previously appeared in the location of the shown square"];


        var instructions_test_squares = {
            type: 'survey-multi-choice',
            questions: [
                { prompt: "How many squares will be initially shown?", name: 'set_size', correct: '4 or 8', options: Q1_square_options, required: true },
                { prompt: "The single square will appear after the squares will disappear ", name: 'steps', correct: 'True', options: Q2_square_options, required: true },
                { prompt: "How do you choose if a square is same or different?", name: 'choose_square', correct: "Press the ‘" + mapping[0] + "’ or ‘" + mapping[1] + "’ key.", options: Q3_square_options, required: true },
                { prompt: "What should you try to remember?", name: 'remember', correct: "The colors and locations of the 'memory' squares", options: Q4_square_options, required: true },
                { prompt: "What is your task?", name: 'task', correct: "To tell if the 'test' square is in the same color as the square previously appearing in this location", options: Q5_square_options, required: true },
            ],
            data: { trial_name: 'test_squares' }
        };

        var if_trial_squares = {
            type: 'html-button-response',
            stimulus: "<p>Sorry. You made a mistake.<br>"
                + "Let’s go back to the instructions. "
                + "Please read them carefully before submitting your answers. <br>"
                + "Thank you!",
            choices: ['Back to instructions']
        }
        /* the to_repeat variable defined whether the quiz is to be repeate*/
        var to_repeat_squares;
        var check_answers = {
            timeline: [if_trial_squares],
            conditional_function: function () {
                // get the data from the previous trial,
                // and check which key was pressed
                to_repeat_squares = false;
                var responses_to_test_square = JSON.parse(jsPsych.data.get().filter({ trial_type: 'survey-multi-choice' }).last(1).select('responses').values[0])
                for (i = 0; i < instructions_test_squares.questions.length; i++) {
                    current_name = instructions_test_squares.questions[i].name;
                    current_correct = instructions_test_squares.questions[i].correct
                    if (current_correct != responses_to_test_square[current_name]) {
                        to_repeat_squares = true;
                        return to_repeat_squares
                    }
                    else {
                        to_repeat_squares = false;
                    }
                }
                return to_repeat_squares
            }
        }

        var instructions_squares_loop = {
            timeline: [instructions_squares, instructions_test_squares, check_answers],
            loop_function: function () {
                if (to_repeat_squares == true) {
                    return true;
                } else {
                    return false;
                }
            }
        }

        /*This function downloads the data */
        function download_csv(csv) {
            var hiddenElement = document.createElement('a');
            file_name = "task.csv"
            hiddenElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
            hiddenElement.target = '_blank';
            hiddenElement.download = file_name;
            hiddenElement.click();
        }
        
        /*---------------------------------------------------- 
        Start practice
        ------------------------------------------------------*/
        var timeline = [];
        /*init connection with pavlovia.org
        var pavlovia_init = {
			type: jsPsychPavlovia,
			command: "init"

        };
        timeline.push(pavlovia_init);*/
        timeline.push(enter_fullscreen)
        var start_practice_only_cards = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '<div>We will now do a few practice trials. <br> Please be ready with your fingers on <b>"s"</b> and <b>"k".</b> <br><br> <b> Press any key to begin</b></div>',
            post_trial_gap: 1000,
            on_finish: function () { document.querySelector('head').insertAdjacentHTML('beforeend', '<style id="cursor-toggle"> html { cursor: none; } </style>') },
        }

        var fixation_cards = { 
            type: jsPsychHtmlKeyboardResponse,
            stimulus: fixation,
            choices: "NO_KEYS",
            trial_duration: 900
        }

        var practice_cards = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: function () {
                return draw_show_cards(current_cards_practice_trial,practice_deck_images)
            },
            choices: "ALL_KEYS",
            trial_duration: 6000,
            data: { phase: 'practice', trial_name: 'cards1', trial_num: function () { return current_cards_practice_trial } },

        }
        
        var practice_choice = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: show_choice,
            choices: "NO_KEYS",
            trial_duration: 500,
            data: { phase: 'practice', trial_name: 'choice1', trial_num: function () { return current_cards_practice_trial } },
            on_finish: function (data) {
                data.key_selected = selected
                if (selected == 0) {
                    data.card_selected = practice_deck_images.indexOf(left_card)
                }
                else if (selected == 1) {
                    data.card_selected = practice_deck_images.indexOf(right_card)
                }
            }
        }

        var practice_reward= {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: function () {
                return show_reward(current_cards_practice_trial)
            },
            choices: "NO_KEYS",
            trial_duration: 750,
            data: { phase: 'practice', trial_name: 'reward1', trial_num: function () { return current_cards_practice_trial } }
            , on_finish: function (data) {
                data.reward = reward;
                current_cards_practice_trial+=1
            }
        }

        /*---------------------------------------------------- 
        Start exp part of card game
        ------------------------------------------------------*/

        var start_exp_cards = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '<div> Good job! Practice completed. <br> <br> We will now move on to the real game. Do your best to figure out which cards are better. Good luck!<br><br> <b>Press any key to continue.</b></div>',
            post_trial_gap: 1000,
        }

        var start_block = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: function () {
                return '<p><b><u>Test block ' + (block + 1) + ' out of ' + (blocks) + '</u></b></p>' + '<p style="text-align: left"> You will now start a test block. Below are the four shapes that can appear in this round.</p>'
                    + '<p style="text-align: left">Use the LEFT or RIGHT response keys ("s" or "k", in correspondence) to make your selection. <br> Please do your best to win as many coins as possible!<br> </p>'
                    + '<p style="text-align: left"><b>Remember that:</b> <br> 1) How ‘good’ each shape is will not change along the round <br> 2) Only the shapes (not the response key that was used to select them) are important when you choose <br> 3) The chance that each shape will give you coins has nothing to do with the other shapes </p>'
                    + '<p><b>Press SPACE to start</b></p>'
                    + '<img class="start" src="' + images_for_block_start()[0] + '">  ' + '<img class="start" src="' + images_for_block_start()[1] + '">    ' + '<img class="start" src="' + images_for_block_start()[2]
                    + '">    ' + '<img class="start" src="' + images_for_block_start()[3] + '">  '
            },
            choices: [" "]
            , post_trial_gap: 1000,
            on_finish: function () { 
                document.querySelector('head').insertAdjacentHTML('beforeend', '<style id="cursor-toggle"> html { cursor: none; } </style>') },
        }

        var exp_cards = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: function () {
                return  draw_show_cards(current_cards_exp_trial,images_for_block_start())
            },
            choices: "ALL_KEYS",
            trial_duration: 6000,
            data: { phase: 'exp', trial_name: 'cards', trial_num: function () { return current_cards_exp_trial }, },

        }

        var exp_choice = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: show_choice,
            choices: "NO_KEYS",
            trial_duration: 500,
            data: { phase: 'exp', trial_name: 'choice', trial_num: function () { return current_cards_exp_trial },},
            on_finish: function (data) {
                data.key_selected = selected
                if (selected == 0) {
                    data.card_selected = images_for_block_start().indexOf(left_card)
                }
                else if (selected == 1) {
                    data.card_selected = images_for_block_start().indexOf(right_card)
                }
            }
        }
        
        var exp_reward = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: function () {
                return show_reward(current_cards_exp_trial)
            },
            choices: "NO_KEYS",
            trial_duration: 750,
            data: {
                phase: 'exp', trial_name: 'reward', trial_num: function () { return current_cards_exp_trial }, block: function () { return block },
                prob1 : function(){return FB_matrix[0]} ,
                prob2 : function(){return FB_matrix[1]},
                prob3 : function(){return FB_matrix[2]},
                prob4 : function(){return FB_matrix[3]}},
                
            on_finish: function (data) {
                current_cards_exp_trial += 1;
                rewards_for_block += reward;
                data.reward = reward;
                data.left_card = images_for_block_start().indexOf(left_card);
                data.right_card = images_for_block_start().indexOf(right_card);
                data.key_selected = selected
                if (selected == 0) {
                    data.card_selected = images_for_block_start().indexOf(left_card)
                }
                else if (selected == 1) {
                    data.card_selected = images_for_block_start().indexOf(right_card)
                }
            }
        }

        var finish_block = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: function () {
                finish_block_string = '<p><b>Good job!</b></p>' + '<p style="text-align: left"><br> Test block<b> ' + (block + 1) + ' out of ' + (blocks) + '</b> is over.'
                finish_block_string += '<br>In this round, you earned <b> ' + rewards_for_block + ' coins</b>.</p>'
                if ((block+1) !=blocks ) {
                    finish_block_string += '<p style="text-align: left"> You can stretch a little and take a short break while sitting in front of the screen, if needed.</p><p> <br><br><br><b>Press SPACE to continue</b>  </p>'
                }
                else {
                    finish_block_string += ' We will now move on.</p><p> <br><br><br><b>Press SPACE to continue</b>  </p>'
                }
                return finish_block_string
            },
            post_trial_gap: 1000,
            choices: [" "],
            on_finish: function () {
                block += 1;
                current_cards_exp_trial = 0;
                rewards_for_block = 0;
            }
        }

        var finish_learning = {
            on_start: function () {
                while (document.querySelector('#cursor-toggle') != null)
                    document.querySelector('#cursor-toggle').remove()
            },
            type: jsPsychHtmlButtonResponse,
            stimulus: function () {
                return "<b>Congratulations!</b> <br><br> You successfully finished the task. <br>"
            },
            choices:["Click here to complete the experiment"]
            , button_html: ['<a href=https://tau-psychology.sona-systems.com/ target="_blank"> %choice%</a>']
        }
        /*---------------------------------------------------- 
        Define timeline for card part
        ------------------------------------------------------*/
        var demo_procedure_only_cards = {
            timeline: [fixation_cards, practice_cards, practice_choice, practice_reward],
            repetitions: 10 //every trial takes 2*(900+6000+1000+750) =8650 ms = 8.65 sec 
        }

        var instructions_loop = {
            timeline: [instructions_cards, start_practice_only_cards, demo_procedure_only_cards, start_instructions_test, instructions_test, check_answers],
            loop_function: function () {
                if (to_repeat == true) {
                    return true;
                } else {
                    return false;
                }
            }
        } //instructions+ 1000 ms + 8.65 + test= 5 min + 9.65 sec + 3 min = 480 + 9.65 sec = 489.65 sec

        var test_procedure_shapes = {
            timeline: [fixation_cards, exp_cards, exp_choice, exp_reward],
            repetitions: 10 // 900+ 6000+ 1000+ 750= 8650 ms= 8.65 sec per trial - 40 trials per block= 346 sec
        }
        
        var test_blocks = {
            timeline: [start_block, test_procedure_shapes, finish_block],
            repetitions: 5
        }; //3*(1+ 346+ 1)= 1044 sec

        var full_procedure_cards = {
            timeline: [preload, instructions_loop, start_exp_cards, test_blocks,finish_learning]
        } //489.65+ 1+ 1044= 1534.65 sec = 25.5775 min
        timeline.push(test_blocks)


        /* finish connection with pavlovia.org 
        var pavlovia_finish = {
        type: jsPsychPavlovia,
        command: "finish",
        participantId: subject_id
        };
        timeline.push(pavlovia_finish);*/
        jsPsych.run(timeline);

    </script>

</body>

</html>
